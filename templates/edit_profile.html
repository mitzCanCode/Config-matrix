{% extends "base.html" %}

{% block title %}Edit Profile - Config Matrix{% endblock %}

{% block content %}

<!-- Modern Sidebar -->
<div class="sidebar">
    <div class="sidebar-main">
        <a href="/dashboard" class="sidebar-item" data-tooltip="Dashboard">
            <i class="bi bi-house-door"></i>
            <span class="sidebar-text">Dashboard</span>
        </a>
        <a href="/computers" class="sidebar-item" data-tooltip="Computers">
            <i class="bi bi-pc-display"></i>
            <span class="sidebar-text">Computers</span>
        </a>
        <a href="/profiles" class="sidebar-item active" data-tooltip="Profiles">
            <i class="bi bi-collection"></i>
            <span class="sidebar-text">Profiles</span>
        </a>
    </div>
    <div class="sidebar-bottom">
        <a href="/logout" class="sidebar-item" data-tooltip="Logout">
            <i class="bi bi-box-arrow-right"></i>
            <span class="sidebar-text">Logout</span>
        </a>
    </div>
</div>

<!-- Main Content Area -->
<div class="main-content">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <!-- Header -->
                <div class="d-flex align-items-center justify-content-between mb-4">
                    <div class="d-flex align-items-center">
                        <a href="/profiles" class="btn btn-outline-primary me-3">
                            <i class="bi bi-arrow-left"></i> Back to Profiles
                        </a>
                        <h1 class="mb-0">Edit Profile: <span id="profile-name">Loading...</span></h1>
                    </div>
                    <button id="save-profile-btn" class="btn btn-success">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                </div>
                
                <!-- Loading spinner -->
                <div id="loading-spinner" class="text-center" style="display: block;">
                    <div class="spinner-border" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                    <p class="mt-2">Loading profile details...</p>
                </div>
                
                <!-- Error message container -->
                <div id="error-container" style="display: none;">
                    <div class="alert alert-danger" role="alert">
                        <h4 class="alert-heading">Error</h4>
                        <p id="error-message"></p>
                    </div>
                </div>

                <!-- Main content container -->
                <div id="profile-content" style="display: none;">
                    <div class="row">
                        <!-- Steps Section - Left Side -->
                        <div class="col-md-8">
                            <!-- Current Steps Section -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Current Steps in Profile</h5>
                                </div>
                                <div class="card-body">
                                    <div id="profile-steps" class="row">
                                        <!-- Profile steps will be dynamically populated here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Available Steps Section -->
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="card-title mb-0">Available Steps to Add</h5>
                                    <button id="create-step-btn" class="btn btn-primary btn-sm">
                                        <i class="bi bi-plus-circle"></i> Create New Step
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="available-steps" class="row">
                                        <!-- Available steps will be dynamically populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Profile Attributes Sidebar - Right Side -->
                        <div class="col-md-4">
                            <div class="card sticky-top" style="top: 20px;">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">Profile Attributes</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="d-flex align-items-center justify-content-between mb-2">
                                            <strong>Preset Attributes:</strong>
                                            <div class="d-flex gap-1">
                                                <button id="attributes-edit-btn" class="btn btn-sm btn-outline-secondary" onclick="editAllAttributes()" style="
                                                    border-color: var(--accent-purple);
                                                    color: var(--accent-purple);
                                                    transition: all 0.3s ease;
                                                " onmouseover="this.style.backgroundColor='var(--accent-purple)'; this.style.color='white';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--accent-purple)';"
                                                >
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button id="attributes-save-btn" class="btn btn-sm btn-success" onclick="saveAllAttributes()" style="display: none;">
                                                    <i class="bi bi-check"></i>
                                                </button>
                                                <button id="attributes-cancel-btn" class="btn btn-sm btn-secondary" onclick="cancelAllAttributes()" style="display: none;">
                                                    <i class="bi bi-x"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div id="attributes-container">
                                            <div class="list-group list-group-flush" id="attributes-list">
                                                <!-- Attributes will be populated here -->
                                            </div>
                                            <div id="attributes-placeholder" class="text-muted text-center py-3" style="font-style: italic; display: none;">No preset attributes set</div>
                                            <div id="add-attribute-form" class="list-group-item" style="display: none;">
                                                <div class="row g-2 align-items-center">
                                                    <div class="col-md-4">
                                                        <input type="text" id="new-attribute-key" class="form-control form-control-sm" placeholder="Key" maxlength="50" style="
                                                               background-color: var(--bg-tertiary);
                                                               border-color: var(--border-color);
                                                               color: var(--text-primary);
                                                           ">
                                                    </div>
                                                    <div class="col-md-8">
                                                        <input type="text" id="new-attribute-value" class="form-control form-control-sm" placeholder="Value" maxlength="255" style="
                                                               background-color: var(--bg-tertiary);
                                                               border-color: var(--border-color);
                                                               color: var(--text-primary);
                                                           ">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="d-flex justify-content-center mt-2">
                                                <button id="add-attribute-btn" class="btn btn-sm btn-outline-secondary" onclick="addNewAttribute()" style="
                                                    border-color: var(--accent-purple);
                                                    color: var(--accent-purple);
                                                    transition: all 0.3s ease;
                                                    display: none;
                                                " onmouseover="this.style.backgroundColor='var(--accent-purple)'; this.style.color='white';" onmouseout="this.style.backgroundColor='transparent'; this.style.color='var(--accent-purple)';"
                                                >
                                                    <i class="bi bi-plus-circle me-1"></i>Add Attribute
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Step Modal -->
<div class="modal fade" id="createStepModal" tabindex="-1" aria-labelledby="createStepModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createStepModalLabel">
                    <i class="bi bi-plus-circle-fill"></i> Create New Step
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createStepForm">
                    <div class="mb-3">
                        <label for="stepName" class="form-label">Step Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="stepName" name="stepName" required 
                               placeholder="Enter step name (e.g., 'Install Chrome', 'Configure Network')" style="
                                   background-color: var(--bg-tertiary);
                                   border-color: var(--border-color);
                                   color: var(--text-primary);
                               ">
                        <div class="invalid-feedback" id="stepNameError"></div>
                    </div>
                    <div class="mb-3">
                        <label for="stepLink" class="form-label">Download Link <span class="text-muted">(Optional)</span></label>
                        <input type="url" class="form-control" id="stepLink" name="stepLink" 
                               placeholder="https://example.com/download" style="
                                   background-color: var(--bg-tertiary);
                                   border-color: var(--border-color);
                                   color: var(--text-primary);
                               ">
                        <div class="form-text">Provide a download link if this step involves downloading software or files.</div>
                        <div class="invalid-feedback" id="stepLinkError"></div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="addToProfile" checked>
                        <label class="form-check-label" for="addToProfile">
                            Add to current profile immediately
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="createStepSubmit">
                    <i class="bi bi-check-circle"></i> Create Step
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const profileId = {{ profile_id }};
    const profileNameElement = document.getElementById('profile-name');
    const profileStepsContainer = document.getElementById('profile-steps');
    const availableStepsContainer = document.getElementById('available-steps');
    const loadingSpinner = document.getElementById('loading-spinner');
    const errorContainer = document.getElementById('error-container');
    const errorMessage = document.getElementById('error-message');
    const profileContent = document.getElementById('profile-content');
    const saveButton = document.getElementById('save-profile-btn');
    
    let currentProfileData = null;
    let hasChanges = false;
    
    function showError(message) {
        errorMessage.textContent = message;
        loadingSpinner.style.display = 'none';
        profileContent.style.display = 'none';
        errorContainer.style.display = 'block';
    }
    
    function showContent() {
        loadingSpinner.style.display = 'none';
        errorContainer.style.display = 'none';
        profileContent.style.display = 'block';
    }
    
    function markChanges() {
        hasChanges = true;
        saveButton.disabled = false;
        saveButton.classList.remove('btn-success');
        saveButton.classList.add('btn-warning');
        saveButton.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Save Changes';
    }
    
    function clearChanges() {
        hasChanges = false;
        saveButton.disabled = true;
        saveButton.classList.remove('btn-warning');
        saveButton.classList.add('btn-success');
        saveButton.innerHTML = '<i class="bi bi-check-circle"></i> Saved';
    }

    function fetchProfileDetails() {
        loadingSpinner.style.display = 'block';
        errorContainer.style.display = 'none';
        profileContent.style.display = 'none';
        
        fetch(`/api/profile/${profileId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch profile details');
                }
                return response.json();
            })
            .then(data => {
                currentProfileData = data;
                profileName = data.name; // Set profile name for attributes API
                profileNameElement.textContent = data.name;
                
                // Populate current profile steps
                profileStepsContainer.innerHTML = '';
                if (data.steps && data.steps.length > 0) {
                    data.steps.forEach(step => {
                        const stepCard = createStepCard(step, true);
                        profileStepsContainer.appendChild(stepCard);
                    });
                } else {
                    profileStepsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">No steps in this profile yet. Add some from the available steps below.</p></div>';
                }

                // Populate available steps for suggestions
                availableStepsContainer.innerHTML = '';
                if (data.available_steps && data.available_steps.length > 0) {
                    data.available_steps.forEach(step => {
                        const stepCard = createStepCard(step, false);
                        availableStepsContainer.appendChild(stepCard);
                    });
                } else {
                    availableStepsContainer.innerHTML = '<div class="col-12"><p class="text-muted text-center">All available steps have been added to this profile.</p></div>';
                }
                
                clearChanges();
                showContent();
                
                // Load attributes after profile name is set
                loadProfileAttributes();
            })
            .catch(error => {
                console.error('Error fetching profile details:', error);
                showError('Failed to load profile details. Please try again.');
            });
    }
    
    function createStepCard(step, isInProfile) {
        const col = document.createElement('div');
        col.className = 'col-md-6 col-lg-4 mb-3';
        
        const card = document.createElement('div');
        card.className = 'card h-100';
        card.style.cssText = `
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-primary) 100%);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        `;
        
        // Add hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 2px 6px rgba(0,0,0,0.1)';
        });
        
        const cardBody = document.createElement('div');
        cardBody.className = 'card-body d-flex flex-column';
        
        if (isInProfile) {
            cardBody.innerHTML = `
                <div class="mb-3">
                    <h6 class="card-title mb-1" style="color: var(--text-primary);">
                        <input type="text" class="form-control form-control-sm step-name-input" 
                               value="${step.name}" data-step-id="${step.id}" 
                               data-original-name="${step.name}" readonly style="
                                   background-color: var(--bg-tertiary);
                                   border-color: var(--border-color);
                                   color: var(--text-primary);
                               ">
                    </h6>
                </div>
                <div class="mb-3">
                    <label class="form-label">Download Link:</label>
                    <input type="url" class="form-control form-control-sm step-link-input" 
                           value="${step.download_link || ''}" data-step-id="${step.id}" 
                           data-original-link="${step.download_link || ''}" readonly style="
                               background-color: var(--bg-tertiary);
                               border-color: var(--border-color);
                               color: var(--text-primary);
                           ">
                </div>
                <div class="mt-auto">
                    <button class="btn btn-sm btn-outline-primary me-2 edit-step-btn" 
                            onclick="toggleEditStep(${step.id})">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="removeStepFromProfile(${profileId}, ${step.id})">
                        <i class="bi bi-trash"></i> Remove
                    </button>
                </div>
            `;
        } else {
            cardBody.innerHTML = `
                <div class="mb-3">
                    <h6 class="card-title mb-1" style="color: var(--text-primary);">
                        ${step.name}
                    </h6>
                </div>
                <div class="mb-3">
                    <small class="text-muted">
                        <i class="bi bi-link-45deg"></i> ${step.download_link || 'No link provided'}
                    </small>
                </div>
                <div class="mt-auto d-flex justify-content-between">
                    <button class="btn btn-sm btn-success" 
                            onclick="addStepToProfile(${profileId}, ${step.id})">
                        <i class="bi bi-plus-circle"></i> Add to Profile
                    </button>
                    <button class="btn btn-sm btn-outline-danger" 
                            onclick="deleteStepFromSuggestions(${step.id})" 
                            title="Delete this step completely">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `;
        }
        
        card.appendChild(cardBody);
        col.appendChild(card);
        return col;
    }
    
    window.toggleEditStep = function(stepId) {
        const nameInput = document.querySelector(`input[data-step-id="${stepId}"].step-name-input`);
        const linkInput = document.querySelector(`input[data-step-id="${stepId}"].step-link-input`);
        const editBtn = document.querySelector(`button[onclick="toggleEditStep(${stepId})"]`);
        
        if (nameInput.readOnly) {
            // Enable editing
            nameInput.readOnly = false;
            linkInput.readOnly = false;
            nameInput.focus();
            editBtn.innerHTML = '<i class="bi bi-check"></i> Save';
            editBtn.classList.remove('btn-outline-primary');
            editBtn.classList.add('btn-success');
        } else {
            // Save changes
            const newName = nameInput.value.trim();
            const newLink = linkInput.value.trim();
            const originalName = nameInput.getAttribute('data-original-name');
            const originalLink = linkInput.getAttribute('data-original-link');
            
            if (!newName) {
                alert('Step name cannot be empty!');
                return;
            }
            
            if (newName !== originalName || newLink !== originalLink) {
                // Make API call to update step
                const updateData = {};
                if (newName !== originalName) updateData.name = newName;
                if (newLink !== originalLink) updateData.download_link = newLink;
                
                fetch(`/api/steps/${stepId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        nameInput.setAttribute('data-original-name', newName);
                        linkInput.setAttribute('data-original-link', newLink);
                        markChanges();
                        alert('Step updated successfully!');
                    } else {
                        alert('Error updating step: ' + data.message);
                        nameInput.value = originalName;
                        linkInput.value = originalLink;
                    }
                })
                .catch(error => {
                    console.error('Error updating step:', error);
                    alert('Error updating step. Please try again.');
                    nameInput.value = originalName;
                    linkInput.value = originalLink;
                });
            }
            
            // Disable editing
            nameInput.readOnly = true;
            linkInput.readOnly = true;
            editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit';
            editBtn.classList.remove('btn-success');
            editBtn.classList.add('btn-outline-primary');
        }
    };

    window.removeStepFromProfile = function(profileId, stepId) {
        if (confirm('Are you sure you want to remove this step from the profile?')) {
            fetch(`/api/profile/${profileId}/steps/${stepId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    markChanges();
                    fetchProfileDetails();
                } else {
                    alert('Error removing step: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error removing step:', error);
                alert('Error removing step. Please try again.');
            });
        }
    };
    
    window.deleteStepCompletely = function(stepId) {
        if (confirm('Are you sure you want to delete this step completely? This action cannot be undone and will only work if the step is not used by other profiles.')) {
            fetch(`/api/steps/${stepId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    markChanges();
                    fetchProfileDetails();
                    alert('Step deleted successfully!');
                } else {
                    alert('Error deleting step: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error deleting step:', error);
                alert('Error deleting step. Please try again.');
            });
        }
    };
    
    window.addStepToProfile = function(profileId, stepId) {
        fetch(`/api/profile/${profileId}/steps`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ step_id: stepId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                markChanges();
                fetchProfileDetails();
            } else {
                alert('Error adding step: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error adding step:', error);
            alert('Error adding step. Please try again.');
        });
    };
    
    window.deleteStepFromSuggestions = function(stepId) {
        if (confirm('Are you sure you want to delete this step completely? This action cannot be undone and will remove the step from all profiles that use it.')) {
            fetch(`/api/steps/${stepId}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Step deleted successfully!', 'success');
                    markChanges();
                    fetchProfileDetails();
                } else {
                    showToast('Error deleting step: ' + data.message, 'error');
                }
            })
            .catch(error => {
                console.error('Error deleting step:', error);
                showToast('Error deleting step. Please try again.', 'error');
            });
        }
    };
    
    // Save button event listener
    saveButton.addEventListener('click', function() {
        if (hasChanges) {
            // In a real implementation, you might want to batch save changes
            // For now, we'll just clear the changes indicator
            clearChanges();
            alert('Changes saved successfully!');
        }
    });
    
    // Create Step Modal functionality
    const createStepBtn = document.getElementById('create-step-btn');
    const createStepModal = new bootstrap.Modal(document.getElementById('createStepModal'));
    const createStepForm = document.getElementById('createStepForm');
    const createStepSubmit = document.getElementById('createStepSubmit');
    const stepNameInput = document.getElementById('stepName');
    const stepLinkInput = document.getElementById('stepLink');
    const addToProfileCheckbox = document.getElementById('addToProfile');
    const stepNameError = document.getElementById('stepNameError');
    const stepLinkError = document.getElementById('stepLinkError');
    
    // Show modal when create button is clicked
    createStepBtn.addEventListener('click', function() {
        // Reset form
        createStepForm.reset();
        addToProfileCheckbox.checked = true;
        
        // Clear validation states
        stepNameInput.classList.remove('is-invalid');
        stepLinkInput.classList.remove('is-invalid');
        stepNameError.textContent = '';
        stepLinkError.textContent = '';
        
        // Show modal
        createStepModal.show();
    });
    
    // Form validation
    function validateCreateStepForm() {
        let isValid = true;
        
        // Reset previous validation states
        stepNameInput.classList.remove('is-invalid');
        stepLinkInput.classList.remove('is-invalid');
        stepNameError.textContent = '';
        stepLinkError.textContent = '';
        
        // Validate step name
        const stepName = stepNameInput.value.trim();
        if (!stepName) {
            stepNameInput.classList.add('is-invalid');
            stepNameError.textContent = 'Step name is required.';
            isValid = false;
        } else if (stepName.length < 3) {
            stepNameInput.classList.add('is-invalid');
            stepNameError.textContent = 'Step name must be at least 3 characters long.';
            isValid = false;
        } else if (stepName.length > 100) {
            stepNameInput.classList.add('is-invalid');
            stepNameError.textContent = 'Step name must be less than 100 characters.';
            isValid = false;
        }
        
        // Validate step link (if provided)
        const stepLink = stepLinkInput.value.trim();
        if (stepLink) {
            try {
                new URL(stepLink);
            } catch (e) {
                stepLinkInput.classList.add('is-invalid');
                stepLinkError.textContent = 'Please enter a valid URL.';
                isValid = false;
            }
        }
        
        return isValid;
    }
    
    // Handle form submission
    createStepSubmit.addEventListener('click', function() {
        if (!validateCreateStepForm()) {
            return;
        }
        
        const stepName = stepNameInput.value.trim();
        const stepLink = stepLinkInput.value.trim();
        const shouldAddToProfile = addToProfileCheckbox.checked;
        
        // Disable button and show loading state
        createStepSubmit.disabled = true;
        createStepSubmit.innerHTML = '<i class="bi bi-hourglass-split"></i> Creating...';
        
        // Choose appropriate endpoint based on checkbox
        const endpoint = shouldAddToProfile ? '/api/steps/create-and-add' : '/api/steps';
        const requestData = {
            name: stepName,
            download_link: stepLink
        };
        
        // Add profile_id if adding to profile
        if (shouldAddToProfile) {
            requestData.profile_id = profileId;
        }
        
        fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal
                createStepModal.hide();
                
                // Show success message
                const message = shouldAddToProfile 
                    ? `Step "${stepName}" created and added to profile successfully!`
                    : `Step "${stepName}" created successfully!`;
                alert(message);
                
                // Mark changes and refresh profile details
                markChanges();
                fetchProfileDetails();
            } else {
                alert('Error creating step: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error creating step:', error);
            alert('Error creating step. Please try again.');
        })
        .finally(() => {
            // Re-enable button
            createStepSubmit.disabled = false;
            createStepSubmit.innerHTML = '<i class="bi bi-check-circle"></i> Create Step';
        });
    });
    
    // Real-time validation for step name
    stepNameInput.addEventListener('input', function() {
        const stepName = this.value.trim();
        
        if (stepName) {
            this.classList.remove('is-invalid');
            stepNameError.textContent = '';
        }
    });
    
    // Real-time validation for step link
    stepLinkInput.addEventListener('input', function() {
        const stepLink = this.value.trim();
        
        if (!stepLink) {
            // Empty is valid (optional field)
            this.classList.remove('is-invalid');
            stepLinkError.textContent = '';
        } else {
            try {
                new URL(stepLink);
                this.classList.remove('is-invalid');
                stepLinkError.textContent = '';
            } catch (e) {
                this.classList.add('is-invalid');
                stepLinkError.textContent = 'Please enter a valid URL.';
            }
        }
    });
    
    // Handle Enter key in form
    createStepForm.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            createStepSubmit.click();
        }
    });

    // Profile Attributes Functions
    let profileName = null;
    let originalValues = { attributes: {} };
    
    function loadProfileAttributes() {
        if (!profileName) {
            console.error('Profile name not available yet');
            return;
        }
        
        fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    originalValues.attributes = data.attributes || {};
                    updateAttributesDisplay(originalValues.attributes);
                } else {
                    console.error('Error loading profile attributes:', data.message);
                }
            })
            .catch(error => {
                console.error('Error loading profile attributes:', error);
            });
    }
    
function createAttributeElement(key, value) {
    const attrDiv = document.createElement('div');
    attrDiv.className = 'list-group-item attribute-item';
    attrDiv.dataset.key = key;

    attrDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <span class="attribute-display">
                    <strong>${key}:</strong> ${value}
                </span>
                <div class="attribute-edit-form" style="display: none;">
                    <div class="row g-2 align-items-center">
                        <div class="col-md-4">
                            <input type="text" class="form-control form-control-sm attribute-key-input" value="${key}" maxlength="50">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control form-control-sm attribute-value-input" value="${value}" maxlength="255">
                        </div>
                        <div class="col-md-2 d-flex justify-content-center">
                            <button class="btn btn-sm btn-outline-danger attribute-delete-btn" onclick="deleteAttribute('${key}')" style="display: none;">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    return attrDiv;
}

function updateAttributesDisplay(attributes) {
    const attributesList = document.getElementById('attributes-list');
    const attributesPlaceholder = document.getElementById('attributes-placeholder');

    attributesList.innerHTML = '';

    if (attributes && Object.keys(attributes).length > 0) {
        Object.entries(attributes).forEach(([key, value]) => {
            attributesList.appendChild(createAttributeElement(key, value));
        });
        attributesPlaceholder.style.display = 'none';
    } else {
        attributesPlaceholder.style.display = 'block';
    }
}

window.editAllAttributes = function() {
    const editBtn = document.getElementById('attributes-edit-btn');
    const saveBtn = document.getElementById('attributes-save-btn');
    const cancelBtn = document.getElementById('attributes-cancel-btn');
    const addBtn = document.getElementById('add-attribute-btn');

    editBtn.style.display = 'none';
    saveBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'inline-block';
    addBtn.style.display = 'block';

    const attributeItems = document.querySelectorAll('.attribute-item');
    attributeItems.forEach(item => {
        const display = item.querySelector('.attribute-display');
        const editForm = item.querySelector('.attribute-edit-form');
        const deleteBtn = item.querySelector('.attribute-delete-btn');

        display.style.display = 'none';
        editForm.style.display = 'block';
        deleteBtn.style.display = 'inline-block';
    });
};

window.saveAllAttributes = function() {
    const attributeItems = document.querySelectorAll('.attribute-item');
    const changedAttributes = [];
    const errors = [];

    attributeItems.forEach(item => {
        const originalKey = item.dataset.key;
        const keyInput = item.querySelector('.attribute-key-input');
        const valueInput = item.querySelector('.attribute-value-input');

        const newKey = keyInput.value.trim();
        const newValue = valueInput.value.trim();

        if (!newKey) {
            errors.push(`Key cannot be empty for attribute "${originalKey}"`);
            return;
        }

        if (!newValue) {
            errors.push(`Value cannot be empty for attribute "${originalKey}"`);
            return;
        }

        if (newKey !== originalKey || newValue !== originalValues.attributes[originalKey]) {
            changedAttributes.push({
                originalKey: originalKey,
                newKey: newKey,
                newValue: newValue
            });
        }
    });

    const newKeys = [];
    attributeItems.forEach(item => {
        const newKey = item.querySelector('.attribute-key-input').value.trim();
        if (newKeys.includes(newKey)) {
            errors.push(`Duplicate key: "${newKey}"`);
        } else {
            newKeys.push(newKey);
        }
    });

    if (errors.length > 0) {
        showToast('Errors: ' + errors.join(', '), 'error');
        return;
    }

    if (changedAttributes.length === 0) {
        cancelAllAttributes();
        return;
    }

    let processed = 0;
    const totalChanges = changedAttributes.length;

    function processNextChange() {
        if (processed >= totalChanges) {
            loadProfileAttributes();
            return;
        }

        const change = changedAttributes[processed];
        processed++;

        if (change.originalKey !== change.newKey) {
            fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes/${encodeURIComponent(change.originalKey)}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    return fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes/${encodeURIComponent(change.newKey)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ value: change.newValue })
                    });
                } else {
                    throw new Error(data.message || 'Failed to delete old attribute');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('Attribute updated successfully', 'success');
                    delete originalValues.attributes[change.originalKey];
                    originalValues.attributes[change.newKey] = change.newValue;
                    processNextChange();
                } else {
                    showToast('Error: ' + (data.message || 'Failed to save new attribute'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error: Failed to update attribute', 'error');
            });
        } else {
            fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes/${encodeURIComponent(change.originalKey)}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ value: change.newValue })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message, 'success');
                    originalValues.attributes[change.originalKey] = change.newValue;
                    processNextChange();
                } else {
                    showToast('Error: ' + (data.message || 'Failed to save attribute'), 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error: Failed to save attribute', 'error');
            });
        }
    }
    processNextChange();
};

window.cancelAllAttributes = function() {
    const editBtn = document.getElementById('attributes-edit-btn');
    const saveBtn = document.getElementById('attributes-save-btn');
    const cancelBtn = document.getElementById('attributes-cancel-btn');
    const addBtn = document.getElementById('add-attribute-btn');
    const addForm = document.getElementById('add-attribute-form');

    editBtn.style.display = 'inline-block';
    saveBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    addBtn.style.display = 'none';
    addForm.style.display = 'none';

    document.getElementById('new-attribute-key').value = '';
    document.getElementById('new-attribute-value').value = '';
    
    updateAttributesDisplay(originalValues.attributes);
};
    
    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3 toast-container';
            toastContainer.style.zIndex = '9999';
            toastContainer.style.pointerEvents = 'none';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const alertClass = type === 'error' ? 'danger' : 'success';
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `alert alert-${alertClass} alert-dismissible fade show`;
        toast.setAttribute('role', 'alert');
        toast.style.pointerEvents = 'auto';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (document.getElementById(toastId)) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 150);
            }
        }, 10000);
    }
    
    
    // Add missing functions for attribute management
    window.deleteAttribute = function(key) {
        if (!confirm(`Are you sure you want to delete the attribute "${key}"?`)) {
            return;
        }
        
        fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes/${encodeURIComponent(key)}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                delete originalValues.attributes[key];
                
                const editBtn = document.getElementById('attributes-edit-btn');
                const isInEditMode = editBtn.style.display === 'none';
                
                updateAttributesDisplay(originalValues.attributes);
                
                if (isInEditMode) {
                    const saveBtn = document.getElementById('attributes-save-btn');
                    const cancelBtn = document.getElementById('attributes-cancel-btn');
                    const addBtn = document.getElementById('add-attribute-btn');
                    
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    addBtn.style.display = 'block';
                    
                    const attributeItems = document.querySelectorAll('.attribute-item');
                    attributeItems.forEach(item => {
                        const display = item.querySelector('.attribute-display');
                        const editForm = item.querySelector('.attribute-edit-form');
                        const deleteBtn = item.querySelector('.attribute-delete-btn');
                        
                        display.style.display = 'none';
                        editForm.style.display = 'block';
                        deleteBtn.style.display = 'inline-block';
                    });
                }
            } else {
                showToast('Error: ' + (data.message || 'Failed to delete attribute'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error: Failed to delete attribute', 'error');
        });
    };
    
    window.addNewAttribute = function() {
        const addForm = document.getElementById('add-attribute-form');
        const addBtn = document.getElementById('add-attribute-btn');
        
        addForm.style.display = 'block';
        addBtn.style.display = 'none';
        
        document.getElementById('new-attribute-key').value = '';
        document.getElementById('new-attribute-value').value = '';
        document.getElementById('new-attribute-key').focus();
        
        setupAutoSaveListeners();
    };
    
    function setupAutoSaveListeners() {
        const keyInput = document.getElementById('new-attribute-key');
        const valueInput = document.getElementById('new-attribute-value');
        
        const newKeyInput = keyInput.cloneNode(true);
        const newValueInput = valueInput.cloneNode(true);
        keyInput.parentNode.replaceChild(newKeyInput, keyInput);
        valueInput.parentNode.replaceChild(newValueInput, valueInput);
        
        function handleAutoSave() {
            const key = newKeyInput.value.trim();
            const value = newValueInput.value.trim();
            
            if (key && value) {
                saveNewAttribute();
            } else if (!key && !value) {
                cancelNewAttribute();
            }
        }
        
        newKeyInput.addEventListener('blur', handleAutoSave);
        newValueInput.addEventListener('blur', handleAutoSave);
        
        function handleEnterKey(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleAutoSave();
            }
        }
        
        newKeyInput.addEventListener('keydown', handleEnterKey);
        newValueInput.addEventListener('keydown', handleEnterKey);
    }
    
    function saveNewAttribute() {
        const keyInput = document.getElementById('new-attribute-key');
        const valueInput = document.getElementById('new-attribute-value');
        
        const key = keyInput.value.trim();
        const value = valueInput.value.trim();
        
        if (!key) {
            showToast('Key cannot be empty', 'error');
            keyInput.focus();
            return;
        }
        
        if (!value) {
            showToast('Value cannot be empty', 'error');
            valueInput.focus();
            return;
        }
        
        if (originalValues.attributes.hasOwnProperty(key)) {
            showToast('Attribute with this key already exists', 'error');
            keyInput.focus();
            return;
        }
        
        fetch(`/api/profile/${encodeURIComponent(profileName)}/attributes/${encodeURIComponent(key)}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ value: value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                originalValues.attributes[key] = value;
                
                const editBtn = document.getElementById('attributes-edit-btn');
                const isInEditMode = editBtn.style.display === 'none';
                
                updateAttributesDisplay(originalValues.attributes);
                
                if (isInEditMode) {
                    const saveBtn = document.getElementById('attributes-save-btn');
                    const cancelBtn = document.getElementById('attributes-cancel-btn');
                    const addBtn = document.getElementById('add-attribute-btn');
                    
                    editBtn.style.display = 'none';
                    saveBtn.style.display = 'inline-block';
                    cancelBtn.style.display = 'inline-block';
                    addBtn.style.display = 'block';
                    
                    const attributeItems = document.querySelectorAll('.attribute-item');
                    attributeItems.forEach(item => {
                        const display = item.querySelector('.attribute-display');
                        const editForm = item.querySelector('.attribute-edit-form');
                        const deleteBtn = item.querySelector('.attribute-delete-btn');
                        
                        display.style.display = 'none';
                        editForm.style.display = 'block';
                        deleteBtn.style.display = 'inline-block';
                    });
                    
                    document.getElementById('new-attribute-key').value = '';
                    document.getElementById('new-attribute-value').value = '';
                    document.getElementById('new-attribute-key').focus();
                    setupAutoSaveListeners();
                } else {
                    cancelNewAttribute();
                }
            } else {
                showToast('Error: ' + (data.message || 'Failed to save attribute'), 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error: Failed to save attribute', 'error');
        });
    }
    
    function cancelNewAttribute() {
        const addForm = document.getElementById('add-attribute-form');
        const addBtn = document.getElementById('add-attribute-btn');
        const editBtn = document.getElementById('attributes-edit-btn');
        
        addForm.style.display = 'none';
        
        const isInEditMode = editBtn.style.display === 'none';
        
        if (isInEditMode) {
            addBtn.style.display = 'block';
        } else {
            addBtn.style.display = 'none';
        }
        
        document.getElementById('new-attribute-key').value = '';
        document.getElementById('new-attribute-value').value = '';
    }
    
    // Initialize
    fetchProfileDetails();
});
</script>
{% endblock %}