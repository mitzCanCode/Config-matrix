{% extends "base.html" %}

{% block title %}Computers - Config Matrix{% endblock %}

{% block content %}


<!-- Modern Sidebar -->
<div class="sidebar">
    <div class="sidebar-main">
        <a href="/dashboard" class="sidebar-item" data-tooltip="Dashboard">
            <i class="bi bi-house-door"></i>
            <span class="sidebar-text">Dashboard</span>
        </a>
        <a href="/computers" class="sidebar-item active" data-tooltip="Computers">
            <i class="bi bi-pc-display"></i>
            <span class="sidebar-text">Computers</span>
        </a>
        <a href="/matrix" class="sidebar-item" data-tooltip="Profiles">
            <i class="bi bi-collection"></i>
            <span class="sidebar-text">Profiles</span>
        </a>
    </div>
    <div class="sidebar-bottom">
        <a href="/help" class="sidebar-item" data-tooltip="Help">
            <i class="bi bi-question-circle"></i>
            <span class="sidebar-text">Help</span>
        </a>
        <a href="/logout" class="sidebar-item" data-tooltip="Logout">
            <i class="bi bi-box-arrow-right"></i>
            <span class="sidebar-text">Logout</span>
        </a>
    </div>
</div>

<!-- Main Content Area -->
<div class="main-content">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">Computers</h1>
                
                <!-- Computer actions area -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <label for="computerSearch" class="form-label">Search by Computer Name:</label>
                        <input type="text" class="form-control" id="computerSearch" placeholder="Enter computer name...">
                    </div>
                    <div class="col-md-3">
                        <label for="technicianFilter" class="form-label">Filter by Technician:</label>
                        <select class="form-control" id="technicianFilter">
                            <option value="">All Technicians</option>
                        </select>
                    </div>
                    <div class="col-md-3 offset-md-3 d-flex flex-column justify-content-end">
                        <button id="add-computer-btn" class="btn btn-success">Add Computer</button>
                    </div>
                </div>
                
                <!-- No computers message (initially hidden) -->
                <div id="no-computers-message" class="row" style="display: none;">
                    <div class="col-12 text-center">
                        <p class="text-muted">No computers to show</p>
                    </div>
                </div>
                
                <div class="row" id="computer-cards">
                    <!-- Dynamic content will be loaded here -->
                </div>
<div class="text-center mt-4">
    <div id="loading-spinner" style="display:none;">
        <div class="spinner-border" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>

<!-- Modal -->
<div id="addComputerModal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add New Computer</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form id="add-computer-form">
          <div class="form-group">
            <label for="computerName">Computer Name</label>
            <input type="text" class="form-control" id="computerName" placeholder="Enter computer name" required>
          </div>
          <div class="form-group">
            <label for="computerDeadline">Deadline</label>
            <input type="datetime-local" class="form-control" id="computerDeadline" required>
            <small class="form-text text-muted">Will be displayed as dd/mm/yy at hh:mm</small>
          </div>
          <div class="form-group">
            <label for="profileId">Profile</label>
            <select class="form-control" id="profileId" required>
              <option value="">Select a profile...</option>
            </select>
          </div>
          <div class="form-group">
            <label for="technicianId">Technician</label>
            <select class="form-control" id="technicianId" required>
              <option value="">Select a technician...</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" id="submit-computer">Add Computer</button>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('computer-cards');
    const loadingSpinner = document.getElementById('loading-spinner');
    const noComputersMessage = document.getElementById('no-computers-message');
    const technicianFilter = document.getElementById('technicianFilter');
    const computerSearch = document.getElementById('computerSearch');
    let isLoading = false; // Flag to prevent multiple requests
    let allComputers = []; // Store all computer data for filtering
    let currentFilterId = 0; // Track current filter operation to avoid race conditions
    
    // Toast notification function
    function showToast(message, type = 'success') {
        // Create toast container if it doesn't exist
        let toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) {
            toastContainer = document.createElement('div');
            toastContainer.className = 'position-fixed top-0 end-0 p-3 toast-container';
            toastContainer.style.zIndex = '9999';
            toastContainer.style.pointerEvents = 'none';
            document.body.appendChild(toastContainer);
        }
        
        // Create toast element
        const toastId = 'toast-' + Date.now();
        const alertClass = type === 'error' ? 'danger' : 'success';
        const toast = document.createElement('div');
        toast.id = toastId;
        toast.className = `alert alert-${alertClass} alert-dismissible fade show`;
        toast.setAttribute('role', 'alert');
        toast.style.pointerEvents = 'auto';
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Add toast to container
        toastContainer.appendChild(toast);
        
        // Auto-remove after 10 seconds
        setTimeout(() => {
            if (document.getElementById(toastId)) {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 150);
            }
        }, 10000);
    }

    function loadComputers() {
        if (isLoading) return; // Exit if a request is already in progress
        isLoading = true;
        loadingSpinner.style.display = 'block';

        fetch('/api/computers')
            .then(response => response.json())
            .then(computers => {
                allComputers = computers;
                filterComputers();
                populateTechnicians();

                isLoading = false;
                loadingSpinner.style.display = 'none';
            }).catch(() => {
                isLoading = false;
                loadingSpinner.style.display = 'none';
            });
    }

    technicianFilter.addEventListener('change', filterComputers);
    computerSearch.addEventListener('input', filterComputers);

    // Function to get deadline styling based on time remaining
    function getDeadlineStyle(deadlineStr) {
        if (!deadlineStr || deadlineStr === 'Not set') {
            return { text: 'Not set', class: '', color: '' };
        }

        const now = new Date();
        const deadline = new Date(deadlineStr);
        const timeDiff = deadline - now;
        const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));

        // Format deadline as dd/mm/yy at hh:mm
        const day = String(deadline.getDate()).padStart(2, '0');
        const month = String(deadline.getMonth() + 1).padStart(2, '0');
        const year = String(deadline.getFullYear()).slice(-2);
        const hours = String(deadline.getHours()).padStart(2, '0');
        const minutes = String(deadline.getMinutes()).padStart(2, '0');
        const formattedDate = `${day}/${month}/${year} at ${hours}:${minutes}`;

        let text = formattedDate;
        let colorClass = '';
        let style = '';

        if (timeDiff < 0) {
            // Overdue
            text = `${formattedDate} (overdue)`;
            colorClass = 'text-danger';
            style = 'color: #dc3545; font-weight: bold;';
        } else if (daysDiff === 0) {
            // Same day
            colorClass = 'text-danger';
            style = 'color: #dc3545; font-weight: bold;';
        } else if (daysDiff < 7) {
            // Less than a week
            colorClass = 'text-warning';
            style = 'color: #fd7e14; font-weight: bold;';
        } else {
            // More than a week
            colorClass = 'text-success';
            style = 'color: #198754; font-weight: bold;';
        }

        return { text, class: colorClass, style };
    }

    function filterComputers() {
        const selectedTechnicianId = technicianFilter.value;
        const searchTerm = computerSearch.value.toLowerCase().trim();
        
        // Increment filter ID to track this specific filter operation
        const filterId = ++currentFilterId;
        
        const filteredComputers = allComputers.filter(computer => {
            // Filter by technician
            const technicianMatch = !selectedTechnicianId || computer.technician_id === parseInt(selectedTechnicianId);
            // Filter by name search - using startsWith instead of includes
            const nameMatch = !searchTerm || computer.name.toLowerCase().startsWith(searchTerm);
            
            return technicianMatch && nameMatch;
        });

        container.innerHTML = '';
        noComputersMessage.style.display = filteredComputers.length === 0 ? 'block' : 'none';

        filteredComputers.forEach((computer, index) => {
            setTimeout(() => {
                fetch(`/api/computer_info/${encodeURIComponent(computer.name)}`)
                    .then(response => response.json())
                    .then(computerData => {
                    // Only add card if this is still the current filter operation
                    if (!computerData.Error && filterId === currentFilterId) {
                        const card = document.createElement('div');
                        card.className = 'col-md-4 mb-4';
                        let completed = parseInt(computerData.completed_steps_num) || 0;
                        let total = parseInt(computerData.total_step_num) || 0;
                        let progressPercentage = total > 0 ? Math.round((completed / total) * 100) : 0;
                        
                        // Get deadline styling
                        const deadlineStyle = getDeadlineStyle(computerData.deadline);
                        
                        card.innerHTML = `
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="card-title mb-0">${computerData.name}</h5>
                                </div>
                                <div class="card-body d-flex flex-column">
                                    <p class="mb-2"><strong>Profile:</strong> ${computerData.profile ? computerData.profile.name : 'No profile'}</p>
                                    <p class="mb-2"><strong>Technician:</strong> ${computerData.technician ? computerData.technician.name : 'Unassigned'}</p>
                                    <p class="mb-2"><strong>Deadline:</strong> <span class="${deadlineStyle.class}" style="${deadlineStyle.style}">${deadlineStyle.text}</span></p>
                                    <p class="mb-3"><strong>Steps:</strong> ${completed}/${total} completed</p>
                                    <div class="progress-section mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <span class="progress-label">Setup Progress</span>
                                            <span class="progress-percentage">${progressPercentage}%</span>
                                        </div>
                                        <div class="custom-progress-bar">
                                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                                        </div>
                                    </div>
                                    <div class="mt-auto">
                                        <a href="/configurations" class="btn btn-primary w-100">
                                            <i class="bi bi-arrow-right"></i> Continue Setup
                                        </a>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.appendChild(card);
                    }
                });
            }, index * 50); // 50ms delay between each request
        });
    }

    function populateTechnicians() {
        fetch('/api/technicians')
            .then(response => response.json())
            .then(technicians => {
                if (!technicians.Error) {
                    technicians.forEach(technician => {
                        const option = document.createElement('option');
                        option.value = technician.id;
                        option.textContent = technician.name;
                        technicianFilter.appendChild(option);
                    });
                }
            });
    }

    // Load all computers at once
    loadComputers();

    // Modal functionality
    const addComputerBtn = document.getElementById('add-computer-btn');
    const addComputerModal = document.getElementById('addComputerModal');
    const submitComputerBtn = document.getElementById('submit-computer');
    const addComputerForm = document.getElementById('add-computer-form');
    const closeButtons = document.querySelectorAll('[data-dismiss="modal"]');

    // Function to populate dropdowns
    function populateDropdowns() {
        // Populate profiles dropdown
        fetch('/api/profiles')
            .then(response => response.json())
            .then(profiles => {
                const profileSelect = document.getElementById('profileId');
                profileSelect.innerHTML = '<option value="">Select a profile...</option>';
                
                if (profiles.Error) {
                    console.error('Error fetching profiles:', profiles.Error);
                    profileSelect.innerHTML += '<option value="" disabled>Error loading profiles</option>';
                } else {
                    profiles.forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = `${profile.name}${profile.description ? ' - ' + profile.description : ''}`;
                        profileSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching profiles:', error);
                const profileSelect = document.getElementById('profileId');
                profileSelect.innerHTML += '<option value="" disabled>Error loading profiles</option>';
            });

        // Populate technicians dropdown
        fetch('/api/technicians')
            .then(response => response.json())
            .then(technicians => {
                const technicianSelect = document.getElementById('technicianId');
                technicianSelect.innerHTML = '<option value="">Select a technician...</option>';
                
                if (technicians.Error) {
                    console.error('Error fetching technicians:', technicians.Error);
                    technicianSelect.innerHTML += '<option value="" disabled>Error loading technicians</option>';
                } else {
                    technicians.forEach(technician => {
                        const option = document.createElement('option');
                        option.value = technician.id;
                        option.textContent = technician.name;
                        technicianSelect.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error fetching technicians:', error);
                const technicianSelect = document.getElementById('technicianId');
                technicianSelect.innerHTML += '<option value="" disabled>Error loading technicians</option>';
            });
    }

    // Show modal
    addComputerBtn.addEventListener('click', function() {
        addComputerModal.classList.add('show');
        document.body.classList.add('modal-open');
        
        // Populate dropdowns when modal opens
        populateDropdowns();
    });

    // Hide modal
    function hideModal() {
        addComputerModal.classList.remove('show');
        document.body.classList.remove('modal-open');
        addComputerForm.reset();
    }

    // Close modal events
    closeButtons.forEach(button => {
        button.addEventListener('click', hideModal);
    });

    // Close modal when clicking outside
    addComputerModal.addEventListener('click', function(e) {
        if (e.target === addComputerModal) {
            hideModal();
        }
    });

    // Handle form submission
    submitComputerBtn.addEventListener('click', function() {
        const formData = {
            name: document.getElementById('computerName').value,
            deadline: document.getElementById('computerDeadline').value,
            profile_id: parseInt(document.getElementById('profileId').value),
            technician_id: parseInt(document.getElementById('technicianId').value)
        };
        
        console.log('Form data before validation:', formData);

        // Basic validation
        if (!formData.name || !formData.deadline || !formData.profile_id || !formData.technician_id) {
            showToast('Please fill in all fields', 'error');
            return;
        }

        // Additional validation for numeric fields
        if (isNaN(formData.profile_id) || isNaN(formData.technician_id) || 
            formData.profile_id <= 0 || formData.technician_id <= 0) {
            showToast('Please select valid profile and technician', 'error');
            return;
        }

        // Convert datetime-local to the expected format
        try {
            const dateObject = new Date(formData.deadline);
            if (isNaN(dateObject.getTime())) {
                showToast('Please enter a valid deadline date and time', 'error');
                return;
            }
            // Format as YYYY-MM-DD HH:MM:SS for database storage
            formData.deadline = dateObject.getFullYear() + '-' + 
                               String(dateObject.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(dateObject.getDate()).padStart(2, '0') + ' ' + 
                               String(dateObject.getHours()).padStart(2, '0') + ':' + 
                               String(dateObject.getMinutes()).padStart(2, '0') + ':' + 
                               String(dateObject.getSeconds()).padStart(2, '0');
        } catch (error) {
            showToast('Please enter a valid deadline date and time', 'error');
            return;
        }

        // Show loading state
        submitComputerBtn.disabled = true;
        submitComputerBtn.textContent = 'Adding...';

        // Send request to API
        fetch('/api/add_computer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                // Handle non-200 responses
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json().then(errorData => {
                        throw new Error(errorData.Error || `HTTP ${response.status}: ${response.statusText}`);
                    });
                } else {
                    // Handle HTML error pages (like CSRF errors)
                    return response.text().then(htmlText => {
                        if (htmlText.includes('CSRF') || htmlText.includes('csrf')) {
                            throw new Error('Security token expired. Please refresh the page and try again.');
                        }
                        throw new Error(`Server error (${response.status}): Please try again or contact support.`);
                    });
                }
            }
            return response.json();
        })
        .then(data => {
            if (data.message) {
                showToast('Computer added successfully!', 'success');
                hideModal();
                // Reload the computers list
                container.innerHTML = '';
                loadComputers();
            } else if (data.Error) {
                showToast('Error: ' + data.Error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error: ' + (error.message || 'An error occurred while adding the computer'), 'error');
        })
        .finally(() => {
            // Reset button state
            submitComputerBtn.disabled = false;
            submitComputerBtn.textContent = 'Add Computer';
        });
    });
});
</script>

{% endblock %}
